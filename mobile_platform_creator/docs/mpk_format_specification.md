# .mpk 文件格式规范 v2.1

## 1. 概述

.mpk (Mobile Platform Kit) 是一种基于 **标准ZIP** 压缩格式的移动应用容器格式，专为移动平台创建器设计。该格式支持应用代码、资源和元数据的打包，并提供安全机制确保应用在受控环境中运行。

**核心原则**：
- **标准化**：采用广泛使用的ZIP格式，便于工具处理和互操作。
- **清晰结构**：定义了明确的内部目录结构。
- **安全性**：通过数字签名保证完整性和来源。

## 2. 文件结构

.mpk 文件是一个标准的 ZIP 压缩文件，**必须** 包含以下目录和文件：

```
example_app.mpk
├── manifest.json         # 应用清单（必需）
├── code/                 # 代码目录（必需）
│   └── ...               # 应用代码文件（至少一个）
├── assets/               # 资源目录（可选，但推荐包含）
│   └── ...               # 静态资源文件
├── config/               # 配置目录（可选）
│   └── ...               # 应用配置文件
└── signature.sig         # 数字签名文件（必需）
```

### 2.1 manifest.json (必需)

应用清单文件，使用 JSON 格式，UTF-8编码。**必须** 包含以下字段：

```json
{
  "format_version": "2.1",           // MPK格式版本号 (必需, 字符串)
  "id": "com.example.app",           // 应用唯一ID (必需, 字符串, 推荐使用反向域名)
  "name": "示例应用",                // 应用名称 (必需, 字符串)
  "version": "1.0.0",                // 应用版本名称 (必需, 字符串, 遵循语义化版本)
  "platform": "all",                 // 目标平台 (必需, 字符串, 如 "android", "ios", "desktop", "all")
  "min_platform_version": "1.0.0",   // 平台最低版本要求 (必需, 字符串)
  "code_type": "javascript",         // 主要代码类型 (必需, 字符串: "javascript", "python", "wasm", "binary", "web")
  "entry_point": "code/main.js",     // 应用入口点 (必需, 字符串, 相对于MPK包根目录的路径)

  // --- 可选字段 ---
  "version_code": 1,                 // 应用版本号 (可选, 整数)
  "description": "这是一个示例应用。", // 应用描述 (可选, 字符串)
  "author": {                        // 作者信息 (可选, 对象)
    "name": "作者名称",
    "email": "author@example.com"
  },
  "icon": "assets/icon.png",         // 应用图标路径 (可选, 字符串, 相对于MPK包根目录的路径)
  "splash": "assets/splash.png",     // 启动画面路径 (可选, 字符串)
  "permissions": [                   // 应用所需权限列表 (可选, 字符串数组)
    "storage",
    "network",
    "camera"
  ],
  "dependencies": [                  // 依赖列表 (可选, 对象数组)
    {
      "name": "依赖库名称",
      "version": ">=1.0.0"
    }
  ],
  "sandbox": {                       // 沙箱配置 (可选, 对象)
    "max_storage": 104857600,        // 最大存储空间（字节）
    "max_memory": 536870912          // 最大内存使用（字节）
  },
  "extra_data": {                    // 其他自定义元数据 (可选, 对象)
    "custom_key": "custom_value"
  }
}
```

**字段说明**：
- `format_version`: 用于标识MPK包遵循的规范版本。解析器应检查此版本以确保兼容性。
- `id`: 全局唯一的应用标识符。
- `version`: 用户可见的版本名称。
- `version_code`: 程序用于版本比较的整数。
- `platform`: 应用设计运行的目标平台。`all` 表示跨平台。
- `min_platform_version`: 运行该应用所需的移动平台创建器（或运行时）的最低版本。
- `code_type`: 指示 `entry_point` 指向的主要代码类型，影响运行时加载方式。
- `entry_point`: 运行时加载和执行的起始文件路径。
- `permissions`: 应用声明需要的系统或平台能力。
- `sandbox`: 定义应用运行时的资源限制。

### 2.2 代码目录 (code/) (必需)

包含应用的可执行代码。
- 必须包含 `manifest.json` 中 `entry_point` 指定的文件。
- 可以包含子目录和库文件。
- 结构取决于 `code_type` (例如，JavaScript项目可能包含 `node_modules` 或打包后的文件，Python项目可能包含 `.py` 文件和依赖包)。

### 2.3 资源目录 (assets/) (可选)

包含应用使用的静态资源，如图像、音频、字体、本地化字符串文件等。
- 目录结构由应用自行定义。
- `manifest.json` 中的 `icon` 和 `splash` 路径通常指向此目录下的文件。

### 2.4 配置目录 (config/) (可选)

包含应用的配置文件，例如默认设置、环境配置等。
- 结构和内容由应用自行定义。

### 2.5 签名文件 (signature.sig) (必需)

包含用于验证MPK包完整性和来源的数字签名信息。

**签名过程**：
1.  获取MPK包内除 `signature.sig` 文件外的所有文件的**相对路径**和**文件内容**。
2.  对文件列表按照**相对路径**进行**字典序排序**。
3.  依次计算每个文件的哈希值（推荐 SHA-256）。为了确保一致性，计算哈希时应包含文件的相对路径字符串（UTF-8编码）和文件二进制内容。例如，可以 `hash_algo.update(relative_path.encode('utf-8')); hash_algo.update(file_content)`。
4.  将所有文件的哈希值（或将路径和内容串联后计算一个总哈希）组合成一个最终的待签名数据摘要。
5.  使用开发者的私钥对该摘要进行签名（推荐 RSA-SHA256 或 ECDSA-SHA256）。
6.  将签名结果（通常是Base64编码的字符串或二进制数据）写入 `signature.sig` 文件。同时，该文件也可以包含用于验证的公钥证书链信息（例如，采用PKCS#7或其他标准格式）。如果只包含签名本身，则需要提供带外验证公钥的机制。

**验证过程**：
1.  读取 `signature.sig` 文件获取签名值和（可能的）证书信息。
2.  重复签名过程的步骤1-4，计算出包内容的摘要。
3.  使用签名者公钥（从 `signature.sig` 或外部获取）验证签名值是否与计算出的摘要匹配。

## 3. 安全机制

### 3.1 文件完整性和来源验证
- 通过 `signature.sig` 文件中的数字签名确保MPK包未被篡改且来源可信。
- 平台或运行时**必须**在加载或安装MPK包之前验证签名。

### 3.2 代码安全
- 应用代码在受限的沙箱环境中运行。
- 具体限制由 `manifest.json` 中的 `sandbox` 配置和运行时的安全策略决定。

### 3.3 权限系统
- 应用通过 `manifest.json` 中的 `permissions` 字段声明所需权限。
- 运行时根据这些声明和用户授权来控制对敏感API或资源的访问。

## 4. 版本兼容性

- **MPK格式版本 (`format_version`)**：定义了MPK文件本身的结构和 `manifest.json` 的核心字段。解析器应至少能处理等于或低于其支持版本的MPK包。遇到更高版本时，应提示不兼容或尝试以兼容模式处理。
- **平台版本 (`min_platform_version`)**：定义了运行该应用所需的最低平台（运行时）版本。平台在加载应用前应检查此字段。
- **应用版本 (`version`, `version_code`)**：用于应用自身的更新和管理。

解析器在处理 `manifest.json` 时应设计为可容忍未知字段，以保证向前兼容性。

## 5. 工具支持

- **MPK打包工具**：根据本规范创建 `.mpk` 文件，包括内容组织、`manifest.json` 生成和签名。
- **MPK解析/验证库**：用于在不同平台（Python后端、Android客户端等）解析、验证和提取 `.mpk` 文件内容。
- **MPK运行时加载器**：负责根据 `manifest.json` 信息加载和执行应用代码。

## 6. 示例 (与第2节结构一致)

## 7. 未来扩展

未来版本可能会考虑：
- 加密特定文件或目录。
- 更完善的依赖管理和解析。
- 增量更新机制。
- 支持多语言资源包。
- 统一的配置管理API。 